<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - animation - keyframes</title>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
		/>
		<style>
			body {
				margin: 0;	
				padding: 0;
                width: 100vw;
                height: 100vh;
				overflow: hidden;
			}
            .b {
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                background-color: aquamarine;
                overflow: hidden;

            }
            .btns {
                position: absolute;
                left: 0;
                top: 0;
            }
            .box {
                display: flex;
                justify-content: center;
                align-items: center;
                background-size: cover;
                background-color: rgb(40, 202, 78);
                position: relative;
            }
		</style>
	</head>
	<body>
        <div class="b">
            <div class="box"></div>
        </div>
        <div class="btns">
            <button class="btnL">变大</button>
            <button class="btnS">变小</button>
            <button class="btnE">重置</button>
            <button class="btn">保存</button>
            <button class="btnA">加载</button>
        </div>
		<script>
            init()
            async function init() {
                let positions = []
                let savePositions = []
                let scale = 1

                // 加载图片设置画布尺寸
                let url = 'https://tszh-images.oss-cn-hangzhou.aliyuncs.com/tszh_images/20220728/62e2506ad50ad.jpg'
                let size = await getImageSize(url);
                var box = document.querySelector('.box');
                box.style.backgroundImage = `url(${url})`
                box.style.width = size.width + 'px'
                box.style.height = size.height +'px'

                // 放大
                let btnL = document.querySelector('.btnL')
                btnL.addEventListener('click', () => {
                    scale+=0.2
                    box.style.transform = `scale(${scale})`
    
                    var children = box.querySelectorAll("*");
                    children.forEach(function(child) {
                        box.removeChild(child);
                    });
                    draw(positions)
                })
                // 缩小
                let btnS = document.querySelector('.btnS')
                btnS.addEventListener('click', () => {
                    scale-=0.2
    
                    box.style.transform = `scale(${scale})`
                    var children = box.querySelectorAll("*");
                    children.forEach(function(child) {
                        box.removeChild(child);
                    });
                    draw(positions)
                })
                // 重置
                let btnE = document.querySelector('.btnE')
                btnE.addEventListener('click', () => {
                    scale = 1
                    box.style.transform = `scale(${scale})`
                    var children = box.querySelectorAll("*");
                    children.forEach(function(child) {
                        box.removeChild(child);
                    });
                    positions = []
                })
                // 加载
                let btnA = document.querySelector('.btnA')
                btnA.addEventListener('click', () => {
                    var children = box.querySelectorAll("*");
                    children.forEach(function(child) {
                        box.removeChild(child);
                    });
                    draw(savePositions)
                    positions = JSON.parse(JSON.stringify(savePositions))

                })
                // 保存
                let btn = document.querySelector('.btn')
                btn.addEventListener('click', () => {
                    savePositions = JSON.parse(JSON.stringify(positions))
                })

                // 添加打点
                box.addEventListener('click',(e) => {
                    if (e.target.className !== 'box') return
                    let boxData  = box.getBoundingClientRect()
                    positions.push({x: e.offsetX, y: e.offsetY, parentData: boxData})
                    draw([{x: e.offsetX, y: e.offsetY, parentData: boxData}])
                    
                })

                // 绘制打点
                function draw(datas) {
                    let curData = box.getBoundingClientRect()
                    datas.forEach((d) => {
                        // let rate = curData.width / d.parentData.width
                        let div = document.createElement('div')
                        div.style.width = 20 + 'px'
                        div.style.height = 20 + 'px'
                        div.style.backgroundColor = 'red'
                        div.style.position = 'absolute'
                        div.style.left = d.x+'px'
                        div.style.top = d.y+'px'
    
                        div.style.borderRadius = 50 + '%'
                        div.addEventListener('click', () => {
                            alert(JSON.stringify(d))
                            console.log(JSON.stringify(d))
                        })
                        box.appendChild(div)
                    })
                    console.log(datas);
                }
            }

            
            function getImageSize(url) {
                return new Promise(function (resolve, reject) {
                    let image = new Image();
                    image.onload = function () {
                        resolve({
                            width: image.width,
                            height: image.height
                        });
                    };
                    image.onerror = function () {
                        reject(new Error('error'));
                    };
                    image.src = url;
                });
            }

		</script>
	</body>
</html>
